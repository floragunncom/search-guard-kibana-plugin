variables:
  REGISTRY_MIRROR: "http://host.docker.internal:5000"
  DOCKER_TLS_CERTDIR: ""

.dind_mirror:
  services:
    - name: floragunncom/alpine-docker:260213
      alias: docker
      command:
        - "--registry-mirror=http://host.docker.internal:5000"
        - "--insecure-registry=host.docker.internal:5000"
  before_script:
    - |
      docker info 2>&1 | grep -A2 "Registry Mirrors" || echo "No registry mirror configured"
      getent hosts host.docker.internal || echo "host.docker.internal: not resolvable"
      curl -sf --max-time 3 ${REGISTRY_MIRROR}/v2/_catalog 2>/dev/null && echo "" || echo "[ ERROR ] !!!!!! Registry not reachable at ${REGISTRY_MIRROR:-<not set>}"
      if [ "${REGISTRY_MIRROR_DEBUG:-false}" = "true" ]; then
        echo "--- REGISTRY_MIRROR=$REGISTRY_MIRROR DOCKER_HOST=${DOCKER_HOST:-local socket}"


        echo "=== PULL TEST (1st) ==="
        docker rmi golang:1.23 2>/dev/null || true
        time docker pull golang:1.23

        echo "=== PULL TEST (2nd - cache hit) ==="
        docker rmi golang:1.23
        time docker pull golang:1.23

        echo "=== DEBUG: REGISTRY CATALOG (after pull) ==="
        curl -sf --max-time 3 ${REGISTRY_MIRROR}/v2/_catalog 2>/dev/null && echo "" || echo "[ ERROR ] !!!!! catalog not reachable"
        echo "=== DONE ==="
      fi
