variables:
  REGISTRY_MIRROR: "http://host.docker.internal:5000"
  DOCKER_TLS_CERTDIR: ""

.dind_mirror:
  services:
    - name: docker:${DOCKER_VERSION}-dind
      alias: docker
      command:
        - "--registry-mirror=http://host.docker.internal:5000"
        - "--insecure-registry=host.docker.internal:5000"
  before_script:
    - |
      docker info 2>&1 | grep -A2 "Registry Mirrors" || echo "No registry mirror configured"
      getent hosts host.docker.internal || echo "host.docker.internal: not resolvable"
      curl -sf --max-time 3 ${REGISTRY_MIRROR}/v2/_catalog 2>/dev/null && echo "" || { echo "[ ERROR ] !!!!!! Registry not reachable at ${REGISTRY_MIRROR:-<not set>}"; exit 1; }
      if [ "${REGISTRY_MIRROR_DEBUG:-false}" = "true" ]; then
        echo "--- REGISTRY_MIRROR=$REGISTRY_MIRROR DOCKER_HOST=${DOCKER_HOST:-local socket}"

        echo "=== docker compose version ==="
        docker compose version

        echo "=== PULL TEST (docker pull, 1st) ==="
        docker rmi alpine:3.20 2>/dev/null || true
        time docker pull alpine:3.20

        echo "=== PULL TEST (docker pull, 2nd - cache hit) ==="
        docker rmi alpine:3.20
        time docker pull alpine:3.20

        echo "=== PULL TEST (docker compose, 1st) ==="
        docker rmi nginx:1.27-alpine 2>/dev/null || true
        printf 'services:\n  test:\n    image: nginx:1.27-alpine\n    command: ["echo", "mirror test ok"]\n' > /tmp/docker-compose-test.yml
        time docker compose -f /tmp/docker-compose-test.yml pull
        docker compose -f /tmp/docker-compose-test.yml run --rm test

        echo "=== PULL TEST (docker compose, 2nd - cache hit) ==="
        docker rmi nginx:1.27-alpine
        time docker compose -f /tmp/docker-compose-test.yml pull
        rm -f /tmp/docker-compose-test.yml

        echo "=== DEBUG: REGISTRY CATALOG (after pull) ==="
        curl -sf --max-time 3 ${REGISTRY_MIRROR}/v2/_catalog 2>/dev/null && echo "" || echo "[ ERROR ] !!!!! catalog not reachable"
        echo "=== DONE ==="
      fi
