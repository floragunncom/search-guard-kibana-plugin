variables:
  REGISTRY_MIRROR: "http://host.docker.internal:5000"
  REGISTRY_MIRROR_HOST: "host.docker.internal:5000"
  REGISTRY_MIRROR_REGISTRIES: "docker.io docker.elastic.co mcr.microsoft.com"
  DOCKER_TLS_CERTDIR: ""

.dind_mirror:
  services:
    - name: docker:${DOCKER_VERSION}-dind
      alias: docker
      command:
        - "--registry-mirror=http://host.docker.internal:5000"
        - "--insecure-registry=host.docker.internal:5000"
  before_script:
    - |
      docker info 2>&1 | grep -A2 "Registry Mirrors" || echo "No registry mirror configured"
      getent hosts host.docker.internal || echo "host.docker.internal: not resolvable"
      curl -sf --max-time 3 ${REGISTRY_MIRROR}/v2/_catalog 2>/dev/null && echo "" || { echo "[ ERROR ] !!!!!! Registry not reachable at ${REGISTRY_MIRROR:-<not set>}"; exit 1; }

      # Configure BuildKit to use registry mirror (for docker compose build / docker build)
      printf '[registry."%s"]\n  http = true\n' "${REGISTRY_MIRROR_HOST}" > /tmp/buildkitd.toml
      for reg in ${REGISTRY_MIRROR_REGISTRIES}; do
        printf '[registry."%s"]\n  mirrors = ["%s"]\n' "$reg" "${REGISTRY_MIRROR_HOST}" >> /tmp/buildkitd.toml
      done
      docker buildx create --name mirror-builder --driver docker-container --driver-opt network=host --config /tmp/buildkitd.toml --use || echo "WARN: could not create buildx mirror-builder"
      if [ "${REGISTRY_MIRROR_DEBUG:-false}" = "true" ]; then
        echo "--- REGISTRY_MIRROR=$REGISTRY_MIRROR DOCKER_HOST=${DOCKER_HOST:-local socket}"

        echo "=== docker compose version ==="
        docker compose version

        echo "=== PULL TEST (docker pull golang, 1st) ==="
        docker rmi golang:1.23 2>/dev/null || true
        time docker pull golang:1.23

        echo "=== PULL TEST (docker pull golang, 2nd - cache hit) ==="
        docker rmi golang:1.23
        time docker pull golang:1.23

        echo "=== BUILD TEST (docker compose build, 1st) ==="
        printf 'services:\n  buildtest:\n    build:\n      context: /tmp/buildtest\n    command: ["echo", "build mirror test ok"]\n' > /tmp/docker-compose-build-test.yml
        mkdir -p /tmp/buildtest
        printf 'FROM alpine:3.20\nRUN echo "built ok"\n' > /tmp/buildtest/Dockerfile
        time docker compose -f /tmp/docker-compose-build-test.yml build

        echo "=== BUILD TEST (docker compose build, 2nd - cache hit) ==="
        docker builder prune -af 2>/dev/null || true
        time docker compose -f /tmp/docker-compose-build-test.yml build
        rm -rf /tmp/buildtest /tmp/docker-compose-build-test.yml

        echo "=== DEBUG: REGISTRY CATALOG (after pull) ==="
        curl -sf --max-time 3 ${REGISTRY_MIRROR}/v2/_catalog 2>/dev/null && echo "" || echo "[ ERROR ] !!!!! catalog not reachable"
        echo "=== DONE ==="
      fi
