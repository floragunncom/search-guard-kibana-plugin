mt_data_migration_tests:
  stage: "Frontend Int Tests"
  image: $SG_BUILD_IMAGE

  rules:
    - if: '$DOCKER_ONLY || $CI_COMMIT_MESSAGE =~ /SKIP-SGI|SKIP-TESTS/ || $CI_COMMIT_TAG =~ /^sg-flx-.*/'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $FORCE_SGI || $CI_COMMIT_MESSAGE =~ /FORCE_SGI/'
      when: manual
  allow_failure: true #Prevents the pipeline from ending in a "Blocked" status.
  tags:
    - test-large
  script:
    - apt-get update
    - apt-get install -y curl jq procps
    - sysctl -w vm.max_map_count=262144
    - git clone --depth 1 --branch $IT_BRANCH https://gitlab-ci-token:${CI_JOB_TOKEN}@git.floragunn.com/private/sgi8.git > /dev/null
    - cd sgi8/mt_data_migration_test
    - ./00_preconditions_check.sh
    - ./01_install_es_and_kibana.sh
    - ./02_restore_es_data_dir.sh
    - ./03_setup_user.sh
    - SCRIPT_DIR=$(pwd) && su - elasticsearch -c "cd $SCRIPT_DIR && ./04_start_es.sh"
    - su - elasticsearch -c "cd $SCRIPT_DIR && ./05_start_kibana.sh"
    - ./20_space_test.sh
    - ./21_data_views.sh
    - ./22_data_view_queries.sh
    - ./23_dashboards.sh
    - ./97_stop_kibana.sh
    - ./98_stop_es.sh