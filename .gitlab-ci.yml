variables:
  SG_JAVA_BUILD_VERSION: "8"
  
image: circleci/openjdk:${SG_JAVA_BUILD_VERSION}-jdk-browsers


before_script:
    - | 
        curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.34.0/install.sh| bash
        export NVM_HOME=~/.nvm
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ]; \. "$NVM_DIR/nvm.sh" 
        export MAVEN_HOME=/opt/apache-maven
        PACKAGE_VERSION=$(cat package.json | jq --raw-output '.version') && echo "PACKAGE_VERSION: $PACKAGE_VERSION"
        ES_VERSION=$(echo $PACKAGE_VERSION | cut -d'-' -f1) && echo "ES_VERSION: $ES_VERSION"
        PLUGIN_VERSION=$(echo $PACKAGE_VERSION | cut -d'-' -f2) && echo "PLUGIN_VERSION: $PLUGIN_VERSION"
        SNAPSHOT=$(echo $PACKAGE_VERSION | cut -d'-' -f3) && echo "SNAPSHOT: $SNAPSHOT"

stages:
 - build
 - test


unittest_and_build:
  stage: build
  script: 
    - if [ "$SNAPSHOT" == "SNAPSHOT" ]; then ./build.sh $ES_VERSION $PLUGIN_VERSION-$SNAPSHOT deploy-snapshot; else echo "Can only deploy SNAPSHOT versions" && exit -1; fi

kibana_nightly_test:
  stage: test
  variables:
    BRANCH: $CI_COMMIT_REF_NAME
    SG_CIRCLE_JOB: "kibana_nightly_test"
  script:
    - "curl --request POST --form token=${CI_JOB_TOKEN} --form ref=kibana_nightly_builds https://git.floragunn.com/api/v4/projects/7/trigger/pipeline"
  only:
    variables:
      - $NIGHTLY_BUILD == "true"